<!DOCTYPE html>
<html>
<head>
    <title>TerraFlow Customer Debug Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        .debug { 
            background: #f0f0f0; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px; 
            border-left: 4px solid #ccc;
            font-family: monospace;
        }
        .error { 
            background: #ffebee; 
            color: #c62828; 
            border-left-color: #f44336;
        }
        .success { 
            background: #e8f5e9; 
            color: #2e7d32; 
            border-left-color: #4caf50;
        }
        .warning { 
            background: #fff3e0; 
            color: #f57c00; 
            border-left-color: #ff9800;
        }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 4px; 
            background: #8B4513; 
            color: white; 
            cursor: pointer; 
            font-size: 14px;
        }
        button:hover { 
            background: #6d3410; 
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .flex { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }
        .product-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            background: #fafafa; 
        }
        .product-title { 
            font-weight: bold; 
            color: #8B4513; 
            margin-bottom: 8px; 
        }
        .product-price { 
            font-size: 18px; 
            color: #2e7d32; 
            font-weight: bold; 
        }
        .product-meta { 
            font-size: 12px; 
            color: #666; 
            margin: 5px 0; 
        }
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #8B4513;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
        }
        .main-content {
            margin-top: 60px;
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">
        TerraFlow Customer Debug Panel - Ready
    </div>
    
    <div class="main-content">
        <div class="container">
            <h1>üîß TerraFlow Customer System Debug Panel</h1>
            <p>Use this panel to test and debug the customer authentication and product loading system.</p>
            
            <div class="flex">
                <button onclick="testFullFlow()">üöÄ Test Complete Flow</button>
                <button onclick="testLogin()">üîê Test Login</button>
                <button onclick="testProducts()">üì¶ Test Products API</button>
                <button onclick="testDashboard()">üè† Test Dashboard API</button>
                <button onclick="checkAuth()">üë§ Check Authentication</button>
                <button onclick="clearAll()">üßπ Clear All Data</button>
            </div>
            
            <div id="results"></div>
            <div id="productGrid" class="grid"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;
        let testResults = [];
        
        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('statusBar');
            const colors = {
                info: '#8B4513',
                success: '#4caf50',
                error: '#f44336',
                warning: '#ff9800'
            };
            statusBar.style.background = colors[type] || colors.info;
            statusBar.textContent = message;
        }
        
        function log(message, type = 'debug') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('results').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
            
            testResults.push({ time: new Date().toLocaleTimeString(), message, type });
        }
        
        async function testFullFlow() {
            log('üöÄ Starting complete customer flow test...', 'success');
            updateStatus('Running complete test flow...', 'info');
            
            try {
                // Step 1: Clear any existing data
                clearStorageData();
                
                // Step 2: Test login
                await performLogin();
                
                // Step 3: Test authentication verification
                await verifyAuthentication();
                
                // Step 4: Test dashboard API
                await testDashboardAPI();
                
                // Step 5: Test products API
                await testProductsAPI();
                
                // Step 6: Display results
                log('‚úÖ Complete flow test finished successfully!', 'success');
                updateStatus('Test completed successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Complete flow test failed: ${error.message}`, 'error');
                updateStatus('Test failed - check logs', 'error');
            }
        }
        
        async function performLogin() {
            log('üîê Step 1: Testing customer login...', 'warning');
            
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: 'testcustomer@example.com',
                    password: 'password123'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentToken = result.token;
                currentUser = result.user;
                localStorage.setItem('terraflow_token', result.token);
                localStorage.setItem('terraflow_user', JSON.stringify(result.user));
                
                log(`‚úÖ Login successful for user: ${result.user.email}`, 'success');
                log(`üìã User Role: ${result.user.role}`, 'success');
                log(`üé´ Token: ${result.token.substring(0, 30)}...`, 'success');
                
                return result;
            } else {
                throw new Error(`Login failed: ${result.message}`);
            }
        }
        
        async function verifyAuthentication() {
            log('üë§ Step 2: Verifying authentication...', 'warning');
            
            const storedToken = localStorage.getItem('terraflow_token');
            const storedUser = localStorage.getItem('terraflow_user');
            
            if (!storedToken) {
                throw new Error('No token found in localStorage');
            }
            
            if (!storedUser) {
                throw new Error('No user data found in localStorage');
            }
            
            try {
                const user = JSON.parse(storedUser);
                log(`‚úÖ Token stored: ${storedToken.substring(0, 30)}...`, 'success');
                log(`‚úÖ User stored: ${user.email} (${user.role})`, 'success');
                
                // Verify token is valid by making a simple authenticated request
                const testResponse = await fetch('http://localhost:5000/api/customer/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${storedToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (testResponse.ok) {
                    log('‚úÖ Token verification successful', 'success');
                } else {
                    throw new Error(`Token verification failed: ${testResponse.status}`);
                }
                
            } catch (e) {
                throw new Error(`Authentication verification failed: ${e.message}`);
            }
        }
        
        async function testDashboardAPI() {
            log('üè† Step 3: Testing dashboard API...', 'warning');
            
            const token = currentToken || localStorage.getItem('terraflow_token');
            
            const response = await fetch('http://localhost:5000/api/customer/dashboard', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                log('‚úÖ Dashboard API successful', 'success');
                log(`üìä Stats: ${JSON.stringify(result.data.stats)}`, 'success');
                log(`üìã Recent Orders: ${result.data.recentOrders.length} items`, 'success');
            } else {
                throw new Error(`Dashboard API failed: ${result.message}`);
            }
        }
        
        async function testProductsAPI() {
            log('üì¶ Step 4: Testing products API...', 'warning');
            
            const token = currentToken || localStorage.getItem('terraflow_token');
            
            const response = await fetch('http://localhost:5000/api/customer/products', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                log(`‚úÖ Products API successful - ${result.data.length} products loaded`, 'success');
                
                // Display product categories
                const categories = [...new Set(result.data.map(p => p.category))];
                log(`üìã Categories found: ${categories.join(', ')}`, 'success');
                
                // Display first few products
                const sampleProducts = result.data.slice(0, 3);
                sampleProducts.forEach((product, index) => {
                    log(`üì¶ Product ${index + 1}: ${product.name} - Rs.${product.price} (${product.category})`, 'success');
                });
                
                // Display products in grid
                displayProducts(result.data);
                
                return result.data;
            } else {
                throw new Error(`Products API failed: ${result.message}`);
            }
        }
        
        function displayProducts(products) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '<h3>üì¶ Products Catalog Preview</h3>';
            
            products.slice(0, 12).forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-title">${product.name}</div>
                    <div class="product-price">Rs. ${product.price}</div>
                    <div class="product-meta">Category: ${product.category}</div>
                    <div class="product-meta">Stock: ${product.stock_quantity} ${product.unit}</div>
                    <div class="product-meta">SKU: ${product.sku}</div>
                    <div class="product-meta">${product.description.substring(0, 100)}...</div>
                `;
                grid.appendChild(card);
            });
        }
        
        async function testLogin() {
            try {
                await performLogin();
                log('üéâ Standalone login test completed', 'success');
            } catch (error) {
                log(`‚ùå Login test failed: ${error.message}`, 'error');
            }
        }
        
        async function testProducts() {
            try {
                await testProductsAPI();
                log('üéâ Standalone products test completed', 'success');
            } catch (error) {
                log(`‚ùå Products test failed: ${error.message}`, 'error');
            }
        }
        
        async function testDashboard() {
            try {
                await testDashboardAPI();
                log('üéâ Standalone dashboard test completed', 'success');
            } catch (error) {
                log(`‚ùå Dashboard test failed: ${error.message}`, 'error');
            }
        }
        
        function checkAuth() {
            log('üë§ Checking current authentication status...', 'warning');
            
            const token = localStorage.getItem('terraflow_token');
            const user = localStorage.getItem('terraflow_user');
            
            if (token) {
                log(`üé´ Token found: ${token.substring(0, 30)}...`, 'success');
                
                // Decode JWT payload (basic decode, not verification)
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    log(`üîç Token payload: ${JSON.stringify(payload)}`, 'success');
                    
                    const expiry = new Date(payload.exp * 1000);
                    const isExpired = expiry < new Date();
                    log(`‚è∞ Token expires: ${expiry.toLocaleString()} ${isExpired ? '(EXPIRED)' : '(Valid)'}`, isExpired ? 'error' : 'success');
                } catch (e) {
                    log('‚ùå Could not decode token', 'error');
                }
            } else {
                log('‚ùå No token found', 'error');
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log(`üë§ User data: ${JSON.stringify(userData)}`, 'success');
                } catch (e) {
                    log('‚ùå User data is corrupted', 'error');
                }
            } else {
                log('‚ùå No user data found', 'error');
            }
        }
        
        function clearStorageData() {
            localStorage.removeItem('terraflow_token');
            localStorage.removeItem('terraflow_user');
            currentToken = null;
            currentUser = null;
        }
        
        function clearAll() {
            clearStorageData();
            document.getElementById('results').innerHTML = '';
            document.getElementById('productGrid').innerHTML = '';
            testResults = [];
            log('üßπ All data cleared', 'success');
            updateStatus('Data cleared - ready for testing', 'info');
        }
        
        // Initialize
        log('üîß TerraFlow Customer Debug Panel initialized', 'success');
        log('Click "Test Complete Flow" to run all tests, or use individual test buttons', 'warning');
        checkAuth();
    </script>
</body>
</html>
